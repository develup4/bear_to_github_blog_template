---
title:  ğŸƒSpring Data JPA

subtitle:  Spring JPA
categories: ìŠ¤í”„ë§ë¶€íŠ¸ 
tags: backend  java  jpa
 
toc: true
toc_sticky: true
---

  
  
## Transaction  
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” `@Transaction`ì—†ì´ë„ ë“±ë¡, ìˆ˜ì •, ì‚­ì œë¥¼ ì²˜ë¦¬í•œë‹¤.  
- `ì„œë¹„ìŠ¤ ê³„ì¸µ(ì™¸ë¶€)`ì—ì„œ Transactionì´ ì‹œì‘ë˜ë©´ í•´ë‹¹ Transactionì„ ì „íŒŒë°›ì•„ì„œ ì‚¬ìš©í•œë‹¤.  
- ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ `Repository(ë‚´ë¶€)`ì—ì„œ ìì²´ì ìœ¼ë¡œ Transactionì„ ì‹œì‘í•œë‹¤.  
  
## ì¿¼ë¦¬ ë©”ì†Œë“œ  
### ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±  
  
-  ìˆœìˆ˜ JPA  
  
```java  
public List<Member> findByUsernameAndAgeGreaterThan(String username, int age) {  
	return em.createQuery("select m from Member m where m.username = :username and m.age > :age")  
		.setParameter("username", username)  
		.setParameter("age", age) .getResultList();  
}  
```  
  
- ìŠ¤í”„ë§ ë°ì´í„° JPA  
  
```java  
public interface MemberRepository extends JpaRepository<Member, Long> {  
	List<Member> findByUsernameAndAgeGreaterThan(String username, int age);  
}  
```  
  
#### ì¡°íšŒ  
- `findâ€¦By`  
- `readâ€¦By`  
- `queryâ€¦By`  
- `getâ€¦By`  
- `findHelloBy`ì²˜ëŸ¼ â€¦ì— ì‹ë³„í•˜ê¸° ìœ„í•œ ë‚´ìš©(ì„¤ëª…)ì´ ë“¤ì–´ê°€ë„ ëœë‹¤.  
  
#### COUNT  
- `long countâ€¦By()`  
  
#### EXISTS  
- `boolean existsâ€¦By()`  
  
#### DELETE  
- `long deleteâ€¦By()`  
- `long removeâ€¦By()`   
  
#### DISTINCT  
- `findDistinct`  
- `findMemberDistinctBy`  
  
#### LIMIT  
- `findFirst3`  
- `findFirst`  
- `findTop`  
- `findTop3`  
  
### @Queryë¥¼ í†µí•´ Repository ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°  
  
```java  
public interface MemberRepository extends JpaRepository<Member, Long> {  
  
	@Query("select m from Member m where m.username= :username and m.age = :age")  
	List<Member> findUser(@Param("username") String username, @Param("age") int age);  
}  
```  
  
- ì´ì „ í•­ëª©ì¸ ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±ì‹œ íŒŒë¼ë©”í„°ê°€ ì¦ê°€í•˜ë©´ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ì´ëŸ° ê²½ìš° `@Query`ë¥¼ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.  
- ì¿¼ë¦¬ë¬¸ì€ JPQLì„ í†µí•´ ì‘ì„±í•œë‹¤.  
- `@Param`ì„ í†µí•´ ì¿¼ë¦¬ë¬¸ì˜ íŒŒë¼ë©”í„°ë¥¼ ë°”ì¸ë”©í•œë‹¤.  
- ì•„ë˜ì™€ ê°™ì´ ì»¬ë ‰ì…˜ì— ëŒ€í•´ì„œë„ `inì ˆ` ì•ˆì˜ íŒŒë¼ë©”í„°ë¥¼ ë°”ì¸ë”© í•  ìˆ˜ ìˆë‹¤.  
  
```java  
@Query("select m from Member m where m.username in :names")  
List<Member> findByNames(@Param("names") List<String> names);  
```  
  
#### ê°’ íƒ€ì… ì¡°íšŒí•˜ê¸°  
  
```java  
@Query("select m.username from Member m")  
List<String> findUsernameList();  
```  
  
#### DTOë¡œ ì§ì ‘ ì¡°íšŒí•˜ê¸°  
  
```java  
@Query("select new study.datajpa.dto.MemberDto(m.id, m.username, t.name) from Member m join m.team t")  
List<MemberDto> findMemberDto();  
```  
  
### ì¡°íšŒ ê²°ê³¼  
- ë‹¤ì–‘í•œ íƒ€ì…ìœ¼ë¡œ ì§€ì •ì´ ê°€ëŠ¥í•˜ë‹¤.  
  
#### ì»¬ë ‰ì…˜  
- ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¹ˆ ì»¬ë ‰ì…˜ì„ ë°˜í™˜í•œë‹¤.  
  
```java  
List<Member> findByUsername(String name);  
```  
  
#### ë‹¨ê±´  
- Optionalì„ ë¶™ì¼ ìˆ˜ë„ ìˆë‹¤.  
- ê²°ê³¼ê°€ ì—†ìœ¼ë©´ null, 2ê±´ ì´ìƒì¼ ê²½ìš° `javax.persistence.NonUniqueResultException`ì¼ ë°œìƒëœë‹¤.  
  
```java  
Member findByUsername(String name);  
Optional<Member> findByUsername(String name);  
```  
  
### ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬  
- ê°€ê¸‰ì  ì‚¬ìš©í•˜ì§€ ë§ì.  
  
```java  
@Query(value = "select * from member where username = ?", nativeQuery = true)  
Member findByNativeQuery(String username);  
```  
  
  
## í˜ì´ì§•ê³¼ ì •ë ¬  
### íŒŒë¼ë©”í„°  
- `org.springframework.data.domain.Sort` : ì •ë ¬ ê¸°ëŠ¥  
- `org.springframework.data.domain.Pageable` : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— Sort í¬í•¨) íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…  
  
### ë°˜í™˜íƒ€ì…  
- `org.springframework.data.domain.Page` : ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•  
- `org.springframework.data.domain.Slice` : ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ (ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)  
- `List (ìë°” ì»¬ë ‰ì…˜)`: ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜  
  
> count ì¿¼ë¦¬ëŠ” ë§¤ìš° ë¬´ê²ë‹¤. ë³„ë„ë¡œ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•´ì„œ ë§Œë“œëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.  
  
### ì˜ˆì œ  
- PageëŠ” 1ì´ ì•„ë‹ˆë¼ 0ë¶€í„° ì‹œì‘í•˜ëŠ” ê²ƒì„ ì£¼ì˜í•˜ì  
  
```java  
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš©  
Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨  
List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨  
List<Member> findByUsername(String name, Sort sort);  
  
// PageRequestëŠ” Pagable ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì´ë‹¤  
PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username")); Page page = memberRepository.findByAge(10, pageRequest);  
  
List<Member> content = page.getContent(); //ì¡°íšŒëœ ë°ì´í„°  
assertThat(content.size()).isEqualTo(3); //ì¡°íšŒëœ ë°ì´í„° ìˆ˜  
assertThat(page.getTotalElements()).isEqualTo(5); //ì „ì²´ ë°ì´í„° ìˆ˜  
assertThat(page.getNumber()).isEqualTo(0); //í˜ì´ì§€ ë²ˆí˜¸  
assertThat(page.getTotalPages()).isEqualTo(2); //ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸  
assertThat(page.isFirst()).isTrue(); //ì²«ë²ˆì§¸ í•­ëª©ì¸ê°€?  
assertThat(page.hasNext()).isTrue(); //ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?  
```  
  
#### DTO ë³€í™˜  
  
```java  
Page<Member> page = memberRepository.findByAge(10, pageRequest);  
Page<MemberDto> dtoPage = page.map(m -> new MemberDto());  
```  
  
### Controllerì—ì„œì˜ í™œìš©  
- ê°„ë‹¨í•œ ê²½ìš°ì— ë§¤ìš° í¸ë¦¬í•˜ê²Œ Paging APIë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.  
  
```java  
// ê¸°ë³¸ í˜ì´ì§€ ì‚¬ì´ì¦ˆ: spring.data.web.pageable.default-page-size=20  
// ìµœëŒ€ í˜ì´ì§€ ì‚¬ì´ì¦ˆ: spring.data.web.pageable.max-page-size=2000  
  
// "/members?page=0&size=3&sort=id,desc&sort=username,desc"  
@GetMapping("/members")  
public Page list(Pageable pageable) {  
	Page page = memberRepository.findAll(pageable);  
	return page;  
}  
  
// ì§ì ‘ ì„¤ì •ê°’ì„ ì§€ì •í•˜ëŠ” ê²½ìš°  
@RequestMapping(value = "/members_page", method = RequestMethod.GET)  
public String list(@PageableDefault(size = 12, sort = "username", direction = Sort.Direction.DESC) Pageable pageable) {  
	Page page = memberRepository.findAll(pageable);  
	return page;  
}  
  
// Dtoë¡œ ë°˜í™˜í•˜ëŠ” ê²½ìš°  
@GetMapping("/members")  
public Page list(Pageable pageable) {  
	return memberRepository.findAll(pageable).map(MemberDto::new);  
}  
```  
  
  
## ë„ë©”ì¸ í´ë˜ìŠ¤ ì»¨ë²„í„°  
- HTTP íŒŒë¼ë©”í„°ë¡œ ë„˜ì–´ì˜¨ Entityì˜ idë¡œ ê°ì²´ë¥¼ ì°¾ì•„ì„œ ë°”ì¸ë”©í•´ì¤€ë‹¤.  
- ì£¼ì˜í•  ì ì€ **ë‹¨ìˆœ ì¡°íšŒìš©**ìœ¼ë¡œ Entityë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ì ì´ë‹¤. ë³€ê²½í•˜ë”ë¼ë„ DBì— ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤.  
  
```java  
@RestController  
public class MemberController {  
  
	private final MemberRepository memberRepository;  
  
	@GetMapping("/members/{id}")  
	public String findMember(@PathVariable("id") Member member) {  
		return member.getUsername();  
	}  
}  
```  
  
  
## Bulk Update ì¿¼ë¦¬  
- ë²Œí¬ì„± ìˆ˜ì • ë° ì‚­ì œëŠ” `@Modifying` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•œë‹¤.  
- ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰ëœë‹¤. ë”°ë¼ì„œ ë™ê¸°í™”ë¥¼ ìœ„í•´ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”**í•´ì•¼ í•œë‹¤.  
- ë²Œí¬ì„± ì¿¼ë¦¬ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ë ¤ë©´ `@Modifying(clearAutomatically = true)`ë¥¼ ì‚¬ìš©í•œë‹¤.  
  
```java  
@Modifying(clearAutomatically = true)  
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")  
int bulkAgePlus(@Param("age") int age);  
```  
  
  
## @EntityGraph  
- ì§€ì—°ë¡œë”©ì€ í›Œë¥­í•œ ê¸°ëŠ¥ì´ì§€ë§Œ `N+1` ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¤ê¸°ë„ í•œë‹¤.  
- í•´ê²°ì„ ìœ„í•´ `fetch join`ì´ë¼ëŠ” ì¢‹ì€ ë°©ë²•ì´ ìˆì§€ë§Œ JPQLì„ ì¨ì•¼í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆë‹¤.  
- ê°„í¸í•œ ì‚¬ìš©ì„ ìœ„í•´ `@EntityGraph`ê°€ ì œê³µë˜ê³  ë‚´ë¶€ì ìœ¼ë¡œ `LEFT OUTER JOIN`ì´ ì‚¬ìš©ëœë‹¤.  
  
```java  
@EntityGraph(attributePaths = {"team"})  
List<Member> findAll();  
  
@EntityGraph(attributePaths = {"team"})  
@Query("select m from Member m")  
List<Member> findMemberEntityGraph();  
  
@EntityGraph(attributePaths = {"team"})  
List<Member> findByUsername(String username);  
```  
  
### @NamedEntityGraph  
- Entityë¥¼ ì •ì˜í•  ë•Œ, EntityGraphì— ì´ë¦„ì„ ë¶™ì—¬ í™œìš©í•  ìˆ˜ ìˆë‹¤.  
  
```java  
// Entity íŒŒì¼  
@NamedEntityGraph(name = "Member.all", attributeNodes = @NamedAttributeNode("team")) @Entity  
public class Member {  
  
}  
  
// Repository íŒŒì¼  
@EntityGraph("Member.all")  
@Query("select m from Member m")  
List<Member> findMemberEntityGraph();  
```  
  
  
## JPA Hintì™€ Lock  
  
```java  
@QueryHints(value = @QueryHint(name = "org.hibernate.readOnly", value = "true"))  
Member findReadOnlyByUsername(String username);		// update ì¿¼ë¦¬ ë“±ì´ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.  
  
@Lock(LockModeType.PESSIMISTIC_WRITE)  
List<Member> findByUsername(String name);  
```  
  
  
## Projections  
- ì›í•˜ëŠ” í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.  
- ë³µì¡í•œ ê²½ìš°ë¥¼ ì²˜ë¦¬í•˜ê¸°ëŠ” ì–´ë ¤ìš°ë¯€ë¡œ ê·¸ëŸ° ê²½ìš°ì—ëŠ” `QueryDSL`ì„ ì‚¬ìš©í•˜ì.  
- ê·¸ë˜ë„ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë³´ë‹¤ ë‚«ë‹¤! ê·¸ëŸ° ê²½ìš° ì‚¬ìš©í•˜ì.  
  
```java  
// Getter í˜•íƒœë¥¼ ì‚¬ìš©  
public interface UsernameOnly {  
	String getUsername();  
}  
  
// SpEL ë¬¸ë²• ì‚¬ìš©(ë‹¤ë§Œ ëª¨ë‘ ê°œë³„ë¡œ ì¡°íšŒí•œ í›„ ì¡°í•©í•œë‹¤)  
public interface UsernameOnly {  
	@Value("#{target.username + ' ' + target.age + ' ' + target.team.name}")  
	String getUsername();  
}  
  
public interface MemberRepository extends JpaRepository<Member, Long> {  
	List<UsernameOnly> findProjectionsByUsername(String username);  
}  
```  
