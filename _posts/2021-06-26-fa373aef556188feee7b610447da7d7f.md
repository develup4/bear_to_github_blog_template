---
title:  (Câºâº) ğŸ’ªStrong pointer

subtitle:  Smartê°€ ì•„ë‹ˆë¼ Strongì…ë‹ˆë‹¤
categories: í”„ë¡œê·¸ë˜ë°ì–¸ì–´ 
tags: cpp  android  strong-pointer
 
---

  
  
```cpp  
#include <stdio.h>  
  
class RefBase  
{  
	int mRefs;  
	public:  
		RefBase():mRefs(0){ printf("RefBase::RefBase()\n"); }  
		virtual ~RefBase(){ printf("RefBase::~RefBase()\n"); }  
		void incStrong() { mRefs++; }  
		void decStrong() { if( â€”mRefs == 0 ) delete this; }  
};  
  
template< typename T >  
class sp  
{  
	T *mPtr;  
	public:  
	    sp(T *ptr) : mPtr(ptr) { mPtr->incStrong(); }  
	    sp(const sp<T> &r) : mPtr(r.mPtr) { mPtr->incStrong(); }  
	    ~sp() {   
			mPtr->decStrong();  
		}  
		T *operator->() { return mPtr; }  
		T &operator*() { return *mPtr; }  
};  
  
class AAA : public RefBase  
{  
	public:  
		AAA(){ printf("AAA::AAA()\n"); }  
		~AAA(){ printf("AAA::~AAA()\n"); }  
		void foo(){ printf("AAA::foo()\n"); }  
};  
  
  
int main()  
{  
	sp<AAA> p1 = new AAA();  
	sp<AAA> p2 = p1;  
	return 0;  
}  
```  
  
ì•ˆë“œë¡œì´ë“œ ë„¤ì´í‹°ë¸Œì—ì„œ ì‚¬ìš©í•˜ëŠ” ì‹¤ì œ ì½”ë“œëŠ” í›¨ì”¬ ë” ê¸¸ê³  ë³µì¡í•˜ì§€ë§Œ í•µì‹¬ë§Œ ì¶”ë¦¬ë©´ ìœ„ì˜ ì½”ë“œì™€ ê°™ë‹¤.  
(ì‹¤ì œ ì½”ë“œëŠ” ë©€í‹°ì½”ì–´ í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬ ì—¬ëŸ¬ê°€ì§€ atomic operationë„ ì‚¬ìš©ë˜ê³  ì•”íŠ¼ ë³µì¡í•˜ë‹¤)  
  
ê°œë…ì€ ì›Œë‚™ `Smart pointer`ê°€ ìœ ëª…í•´ì„œ C++ ì½”ë“œë¥¼ ì–´ëŠì •ë„ ì½ì„ ìˆ˜ ìˆë‹¤ë©´ ë™ì‘ì„ íŒŒì•…í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.  
ê·¸ ìœ ëª…í•œ Effective C++ì˜ ì²« ì£¼ì œê°€ ë°”ë¡œ `RAII(Resource Acquisition Is Initialization)`ì¸ë° **í¬ì¸í„°ë¼ëŠ” ìì›**ì— ëŒ€í•´ì„œ ê·¸ë ‡ê²Œ êµ¬í˜„í–ˆë‹¤ê³  ë³´ë©´ ë ê±°ê°™ë‹¤.  
  
ì£¼ëª©í•´ì„œ ë³¼ë§Œí•œ ë¶€ë¶„ì€ `reference count`ë¥¼ `sp`ê°€ ê°€ì§€ê³  ìˆì§€ ì•Šê³  **pointingë˜ëŠ” ê°ì²´ê°€ ê°€ì§€ê³  ìˆë‹¤ëŠ” ì ì´ë‹¤.**  
ì˜ˆë¥¼ ë“¤ì–´ SPì—ì„œ static member variableì„ ê°€ì§€ê³  ìˆë‹¤ë©´(ë§ë„ ì•ˆë˜ì§€ë§Œ) ì—¬ëŸ¬ `Smart pointer`ë“¤ì´ ì¹´ìš´íŠ¸ë¥¼ ê³µìœ í•´ë²„ë¦´ ê²ƒì´ë‹¤.  
  
ê·¸ë˜ì„œ `RefCountë¥¼ ìƒì†ë°›ëŠ” ê°ì²´`ë§Œì„ `sp`ê°€ í¬ì¸íŒ…í•  ìˆ˜ ìˆë‹¤.  
ê·¸ë¦¬ê³  ê·¸ê²ƒë“¤ ìœ„í•´ ì¸í„°í˜ì´ìŠ¤ ë˜í•œ ë‹¹ì—°íˆ ìƒì†í•˜ëŠ”ë° `IncrementCount`ì™€ `DecrementCount`ê°™ì€ ë™ì‘ë“¤ì´ ì œê³µëœë‹¤.  
  
```cpp  
#include <stdio.h>  
#include "StrongPointer.h"  
#include "RefBase.h"  
  
using namespace android;  
  
class AAA : public RefBase  
{  
	public:  
		AAA(){ printf("AAA::AAA()\n"); }  
		~AAA(){ printf("AAA::~AAA()\n"); }  
		void onFirstRef() { printf("onFirstRef()\n"); }    // ë¶€ëª¨ì˜ ì¸í„°í˜ì´ìŠ¤ê°€ virtual í•¨ìˆ˜ì´ë‹¤  
		void foo(){ printf("AAA::foo()\n"); }  
};  
  
int main()  
{  
	sp<AAA> p1 = new AAA();  
	sp<AAA> p2 = p1;  
	return 0;  
}  
```  
  
í•˜ë‚˜ ë” ì‚´í´ë³¼ì ì€ `onFirstRef()` í•¨ìˆ˜ì´ë‹¤.  
ê°€ìƒí•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì— RefBaseë¥¼ ìƒì†ë°›ëŠ”ë‹¤ë©´ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ê°€ìƒí•¨ìˆ˜ì´ë‹¤. ì´ í•¨ìˆ˜ëŠ” ì²˜ìŒìœ¼ë¡œ ìŠ¤ë§ˆíŠ¸í¬ì¸í„°ì— ê°’ì´ í• ë‹¹ë ë•Œ í˜¸ì¶œë˜ëŠ”ë°, ê·¸ ì´ìœ ëŠ” ì¢€ êµ¬ë¦°ê±° ê°™ë‹¤.  
  
`AAA* p1 = new AAA()`  
  
ìœ ì €ëŠ” Smart pointerë¥¼ ì•ˆì“°ê³  ê°ì²´ë¥¼ ê·¸ëƒ¥ pointerë¡œ ì‚¬ìš©í• ìˆ˜ë„ ìˆëŠ” ê²ƒì´ë‹¤.  
ì´ê²ƒì„ ì»´íŒŒì¼ì—ëŸ¬ ë“±ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ì—†ë‹¤â€¦(ì •ë§ ì—†ë‚˜? êµ¬ê¸€ì´ ëª»í–ˆìœ¼ë©´ ëª»í•œê±´ê°€)  
  
ê·¸ë˜ì„œ ê°ì¢… ë””ë°”ì´ìŠ¤ ë“± ì¤‘ìš”í•œ ê°ì²´ì—ì„œ ì¤‘ìš”í•œ ì´ˆê¸°í™”ëŠ” ìƒì„±ìê°€ ì•„ë‹ˆë¼ onFirstRef()ì—ì„œ í•˜ë„ë¡ ì •ì±…ì„ ì •í•œê²ƒì´ë‹¤. Smart pointerë¥¼ ì•ˆì“°ë©´ ì•ˆë˜ê²Œë”.  
  
ì¢€ ì´ŒìŠ¤ëŸ½ì§€ë§Œ ì–´ì©Œë§Œ ìœ ì¼í•œ ë°©ë²•ì¼ì§€ë„ ëª¨ë¥¸ë‹¤.  
  
```cpp  
#include <stdio.h>  
#include "StrongPointer.h"  
#include "RefBase.h"  
  
using namespace android;  
  
class AAA;  
class BBB;  
  
class AAA : public RefBase  
{  
	public:  
		sp<BBB> pb;  
		AAA(){ printf("AAA::AAA()\n"); }  
		~AAA(){ printf("AAA::~AAA()\n"); }  
		void foo(){ printf("AAA::foo()\n"); }  
};  
  
class BBB : public RefBase  
{  
	public:  
		sp<AAA> pa;  
		BBB(){ printf("BBB::BBB()\n"); }  
		~BBB(){ printf("BBB::~BBB()\n"); }  
		void foo(){ printf("AAA::foo()\n"); }  
};  
  
int main()  
{  
	{  
		sp<AAA> p1 = new AAA();  
		sp<BBB> p2 = new BBB();  
		p1->pb = p2;  
		p2->pa = p1;  
	}  
	printf("step 1.\n");  
  
	return 0;  
}  
```  
  
ì´ë²ˆì—” `sp`ì˜ ìƒí˜¸ì°¸ì¡° ë¬¸ì œì´ë‹¤.  
  
ìœ„ ì˜ˆì œì²˜ëŸ¼ ë©¤ë²„ì¸ `Smart pointer`ê°€ ì„œë¡œë¥¼ ì°¸ì¡°í•  ê²½ìš° ì˜ ìƒê°í•´ë³´ë©´,  
ë©¤ë²„ì˜ ì°¸ì¡°ë¥¼ í†µí•´ì„œ ê°ì²´ì˜ RefCountê°€ 2ê°€ ë˜ë¯€ë¡œ `sp`ê°€ Scopeì—ì„œ ë‚˜ê°€ì„œ ì†Œë©¸ë˜ë”ë¼ë„ `RefCount`ëŠ” 1ì´ ë˜ê³  ê°ì²´ëŠ” ì†Œë©¸ë˜ì§€ ì•ŠëŠ”ë‹¤.  
  
ì´ê²ƒì€ `sp` ë¿ë§Œ ì•„ë‹ˆë¼ Smart pointerë¥˜ê°€ ê³µí†µì ìœ¼ë¡œ ê°€ì§€ëŠ” ë¬¸ì œì´ë‹¤.  
ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ë‹¤ìŒì— ì†Œê°œí•  wp ì¦‰, `Weak pointer`ê°€ ë„ì…ëœë‹¤.  
